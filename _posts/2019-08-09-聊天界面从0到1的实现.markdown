---
layout: post
title: èŠå¤©ç•Œé¢ä»0åˆ°1çš„å®ç° 
date: 2019-08-09 15:12:49 +0300
image:  02.jpeg
tags:    

---

> ä»Šå¤©ï¼Œæˆ‘ç»ˆäºæ›´æ›´æ›´æ›´åšäº†ã€‚
> æ¥ç€ä¸Šä¸€ç¯‡èŠå¤©ç•Œé¢ä»0åˆ°1çš„å®ç°å‰åº
> ä»Šå¤©æ¥èŠä¸€èŠ èŠå¤©é¡µé¢çš„åº•éƒ¨æ¨ªæ¡ã€‚
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<!--more-->

## å†™åœ¨å‰é¢

`JPChatBottomBar ` ä¸ç°åœ¨ä¸»æµçš„èŠå¤©é¡µé¢çš„åº•éƒ¨æ¨ªæ¡é¡µé¢ç›¸ä¼¼ã€‚
ç±»ä¼¼äºå¾®ä¿¡ä¸­çš„ï¼šab

<center>![åº•éƒ¨æ¨ªæ¡](/images/02_post/wechatBottomBar.jpg)</center>

ä¹‹æ‰€ä»¥å…ˆä»è¿™ä¸ªæ¨ªæ¡æ¥æŠ˜è…¾ï¼Œä¸ªäººæƒ³æ³•ï¼šä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œè¿™ä¸ªæ¨¡å—å¯ä»¥ä»Imä¸­ç‹¬ç«‹å‡ºæ¥ï¼Œä½†åˆå¯ä»¥å±è”½æ‰å› é€šä¿¡éƒ¨åˆ†ç¬¬ä¸‰æ–¹æœåŠ¡é€‰æ‹©çš„ä¸åŒè€Œå¸¦æ¥çš„å·®å¼‚ï¼ŒæœåŠ¡äºèŠå¤©çš„æ•´ä¸ªæ¡†æ¶ã€‚ä»¥åå¦‚æœæ¡†æ¶å‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸€æ¨¡å—å—åˆ°çš„å½±å“ä¹Ÿä¼šæ˜¯æœ€å°çš„ã€‚

`JPChatBottomBar`è™½ç„¶å¹¶ä¸æ•´ä¸ªæ¡†æ¶çš„æ ¸å¿ƒï¼Œä½†å´ä¹Ÿæä¾›ç€åŸºç¡€çš„æœåŠ¡åŠŸèƒ½â€”â€”ç¼–è¾‘æ¶ˆæ¯ã€‚
è‡ªå·±åœ¨æ¨¡ä»¿å®ç°ä¸€ä¸ªæ¨ªæ¡çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›éº»çƒ¦ã€‚

ç¢äºç¯‡å¹…ï¼Œæ–‡ç« ä¸­ä¸»è¦ç”¨äºè®°å™ä¸€äº›æ¯”è¾ƒå¤æ‚çš„å®ç°æŠ‘æˆ–æ˜¯ä¸€äº›ç»†èŠ‚çš„é—®é¢˜ï¼Œç®€å•çš„é€»è¾‘åˆ¤æ–­å®ç°å°±ä¸å‡ºç°åœ¨è¿™é‡Œäº†ã€‚

demoçš„åœ°å€æ”¾åœ¨è¿™é‡Œï¼š[JPChatBottomBar--githubåœ°å€](https://github.com/ZhongYupei/JPChatBottomBar)

## åŠŸèƒ½åˆ†æ 
ç»“åˆå‰é¢çš„å›¾ï¼šå¯ä»¥åˆæ­¥æ€»ç»“å‡º `JPChatBottomBar` åº”è¯¥å®ç°çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š

-  1.é”®ç›˜çš„åˆ‡æ¢ï¼›
-  2.ç”¨æˆ·ç”Ÿæˆè¯­éŸ³æ¶ˆæ¯ï¼›
-  3.ç”¨æˆ·å¯¹æ–‡æœ¬æ¶ˆæ¯çš„æ“ä½œï¼ˆç¼–è¾‘ã€åˆ é™¤ã€å‘é€ï¼‰ï¼›
-  4.ç”¨æˆ·æ–‡æœ¬æ¶ˆæ¯ä¸­åµŒå…¥è¡¨æƒ…åŒ…ï¼›
-  5.ç”¨æˆ·ç‚¹å‡»äº†â€˜å¤§â€™è¡¨æƒ…åŒ…(ç±»ä¼¼äºä¸€äº›gifå›¾ç‰‡)ï¼›
-  6.ç”¨æˆ·ç‚¹å‡»æ›´å¤šæŒ‰é’®ï¼Œè¿›è¡Œé€‰æ‹©å…¶ä»–åŠŸèƒ½å®ç°ï¼ˆç±»ä¼¼å¾®ä¿¡ï¼šå›¾åº“ï¼Œæ‹æ‘„ï¼Œå‘é€åœ°å€ç­‰ç­‰ï¼‰ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ ä¸€ä¸ªä»£ç† `JPChatBottomBarDelegate` æ¥å°†ç”¨æˆ·çš„æ“ä½œï¼ˆæ–‡æœ¬æ¶ˆæ¯ã€è¯­éŸ³æ¶ˆæ¯ç­‰ç­‰ï¼‰å‘å¤–ä¼ é€’ï¼Œå³å‘èŠå¤©æ¡†æ¶ä¸­çš„å…¶ä»–æ¨¡å—æä¾›æœåŠ¡ã€‚

å…ˆæ¥å¯¹æˆ‘æ‰€ä½¿ç”¨åˆ°çš„ç±»æ¥è¿›è¡Œè¯´æ˜:

- 1.`JPChatBottomBar ` :  æ•´ä¸ªæ¨ªæ¡
- 2.`preview`æ–‡ä»¶ä¸­çš„ç±»ç”¨äºå®ç°è¡¨æƒ…åŒ…çš„é¢„è§ˆæ•ˆæœ
- 3.`imageResource`æ–‡ä»¶å¤¹ä¸­å­˜æ”¾äº†æ­¤demoä¸­æ‰€ç”¨åˆ°çš„å›¾ç‰‡èµ„æº
- 4.`JPEmojiManager`ï¼šè¿™ä¸ªç±»ç”¨äºè¯»å–æ‰€æœ‰çš„è¡¨æƒ…åŒ…èµ„æº
- 5.`JPPlayerHelper`:è¿™ä¸ªç±»ç”¨äºå®ç°å½•éŸ³å’Œæ’­éŸ³çš„æ•ˆæœ
- 6.`JPAttributedStringHelper`:å®ç°è¡¨æƒ…åŒ…å­ç¬¦å’Œè¡¨æƒ…åŒ…å›¾ç‰‡çš„äº’è½¬
- 7.å…³äº`model`ï¼Œ`JPEmojiModel`ç”¨äºç»‘å®šå•ç‹¬ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œ`JPEmojiGroupModel`ç”¨äºç»‘å®šä¸€æ•´ç»„çš„è¡¨æƒ…åŒ…ã€‚
- 8.`category`ä¸­å­˜æ”¾äº†ä¸€äº›å¸¸ç”¨çš„å·¥å…·ç±»

ä¸‹é¢ï¼Œè®©æˆ‘å°±ä¸Šé¢æ‰€ç½—åˆ—çš„åº”è¯¥å®ç°çš„åŠŸèƒ½ï¼Œæ¥è®²è®²å„åŠŸèƒ½æˆ‘æ˜¯å¦‚ä½•å®ç°æˆ–è€…æ˜¯åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æˆ‘æ‰€é‡åˆ°çš„é—®é¢˜ã€‚

## é”®ç›˜åˆ‡æ¢
å…ˆçœ‹ä¸€ä¸‹æˆ‘æ‰€å®ç°çš„æ•ˆæœã€‚

<center>![é”®ç›˜å¼¹å‡º,ä¸Šé¢çš„è§†å›¾å‘ä¸Šæ»‘åŠ¨](/images/02_post/jianpantanchu.gif)</center>

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é”®ç›˜å¼¹å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œ`controller.view`è¦å‘ä¸Šæ»‘åŠ¨ï¼Œé¿å…å¼¹å‡ºçš„é”®ç›˜é®æŒ¡ä½äº†ç”¨æˆ·çš„èŠå¤©é¡µé¢ã€‚è¿™ä¹Ÿæ˜¯éå¸¸åŸºç¡€çš„åŠŸèƒ½ã€‚

ä½†æ˜¯è¿™é‡Œæœ‰ä¸ª**ç»†èŠ‚**çš„åœ°æ–¹ï¼š

è¿™ä¸€å—ä¸€å¼€å§‹æˆ‘æ˜¯æƒ³é€šè¿‡å†™æ­»ç³»ç»Ÿé”®ç›˜çš„é«˜åº¦ï¼Œé€šè¿‡ç›‘å¬`textView.inputView`æ–°æ—§å€¼çš„å˜åŒ–ï¼ˆkvoå®ç°å‚è€ƒdemoé‡Œé¢ï¼‰ï¼š
ä»demoä¸­çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ç­‰åˆ°`chatBottomBar`åˆ°è¾¾äº†è¯¥åˆ°çš„ä½ç½®ä¹‹åï¼Œå†è°ƒç”¨`-textView reloadInputView`æ¥å”¤é†’é”®ç›˜ã€‚å¦‚æ­¤å°±å¯ä»¥è¾¾åˆ°é”®ç›˜ä»ä¸‹å¼¹å‡ºå¹¶ä¸”ä¸ä¼šæœ‰å°éƒ¨åˆ†è¦†ç›–çš„æ•ˆæœã€‚

ä½†æ˜¯å‘ç°ï¼Œç³»ç»Ÿé”®ç›˜çš„é«˜åº¦ä¸æ˜¯éƒ½ä¸€æ ·çš„ï¼Œä¾‹å¦‚æ±‰è¯­æ‹¼éŸ³çš„ä¹å®«æ ¼é”®ç›˜è¦æ¯”26é”®é«˜ï¼Œè€Œæ—¥è¯­ä¹å®«æ ¼é”®ç›˜è¦æ¯”26é”®ä½ï¼Œæ‰€ä»¥ä¸æ˜¯å¾ˆå…¨ã€‚

äºæ˜¯æœ€åè¿˜æ˜¯é‡‡ç”¨äº†ç›‘å¬é”®ç›˜å¼¹å‡ºçš„é€šçŸ¥æ¥å®ç° :
<center>![é”®ç›˜åˆ‡æ¢è¿‡ç¨‹ä¸­å°éƒ¨åˆ†è¦†ç›–é—®é¢˜](/images/02_post/jianpanbeifugai.gif)</center>

è€Œå¾®ä¿¡åœ¨è¿™ä¸€å—çš„å®ç°å°±æ²¡æœ‰è¿™ç§è¦†ç›–æ•ˆæœï¼Œå¾®ä¿¡ç­‰åˆ°`viewController.view`æ¥åˆ°è¯¥åˆ°çš„ä½ç½®ä¹‹åï¼Œå†è®©é”®ç›˜ä»ä¸‹é¢å¼¹å‡ºã€‚

ç›‘å¬é”®ç›˜å¼¹å‡ºçš„é€šçŸ¥ï¼š

```
// JPChatBottomBar.m
// ç›‘å¬textView.inputViewå±æ€§æ–°æ—§å€¼çš„å˜åŒ–

 [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillChangeRect:) name:UIKeyboardWillChangeFrameNotification object:nil];
 
- (void)keyboardWillChangeRect:(NSNotification *)noti {
    NSValue * aValue =  noti.userInfo[UIKeyboardFrameBeginUserInfoKey];
    self.oldRect = [aValue CGRectValue];
    NSValue * newValue = noti.userInfo[UIKeyboardFrameEndUserInfoKey];
    self.newRect = [newValue CGRectValue];
    [UIView animateWithDuration:0.3 animations:^{
        if(self.superview.y == 0) {
            self.superview.y -= self.newRect.size.height;
        }else {
            self.superview.y -=(self.newRect.size.height - self.oldRect.size.height);
        }
    } completion:^(BOOL finished) {
    }];
}
```

è·¯è¿‡çš„è¯»è€…å¦‚æœæœ‰æ›´å¥½çš„æ”¹è¿›æ–¹æ³•ï¼Œèƒ½åœ¨åˆ‡æ¢é”®ç›˜çš„æ—¶å€™é¿å…è¿™ç§è¦†ç›–ï¼Œæ¬¢è¿æå‡ºï¼Œæˆ‘ä¹Ÿæ˜¯æ­£åœ¨å­¦ä¹ iOS çš„å°ç™½ğŸ˜‚ã€‚è°¢è°¢ğŸ™ğŸ™ğŸ™ 

å…³äºé”®ç›˜çš„åˆ‡æ¢å‰©ä¸‹çš„å°±æ˜¯ æ ¹æ®ç”¨æˆ·çš„ç‚¹å‡»åˆ‡æ¢é”®ç›˜çš„çŠ¶æ€ï¼ˆå˜åŒ–ç›¸åº”çš„è§†å›¾ï¼‰ã€‚
è¿™ä¸€éƒ¨åˆ†å°±å…ˆåˆ°æ­¤â˜ºï¸ğŸ‘ŒğŸ¾ã€‚

## è¯­éŸ³æ¶ˆæ¯
åœ¨å‚è€ƒäº†åˆ«äººçš„Demo([iOSä»¿å¾®ä¿¡å½•éŸ³æ§ä»¶Demo](https://www.jianshu.com/p/37f62d568b71))ä¹‹åï¼Œæˆ‘ä¹Ÿå®ç°äº†ä¸€ä¸ªã€‚

å…ˆç»™å‡ºè‡ªå·±æ‰€ä½¿ç”¨çš„ç±»çš„ä»‹ç»ï¼š
- 1.`JPPlayerHelper`  : å®ç°å½•éŸ³å’Œæ’­éŸ³çš„åŠŸèƒ½ã€‚
- 2.`JPAudioView`: å±•ç¤ºå½•éŸ³çš„çŠ¶æ€

è®©æˆ‘æ¦‚æ‹¬ä¸€ä¸‹ å®ç°çš„å¤§æ¦‚æ­¥éª¤ã€‚
é¦–å…ˆä¸¤ä¸ªç±»ä¹‹é—´å¹¶ä¸æ˜¯ç›¸äº’ä¾èµ–çš„ï¼Œä¸¤è€…åœ¨`JPChatBottomBar`ä¸­äº§ç”Ÿè€¦åˆã€‚

### ä¸Šæ»‘å–æ¶ˆã€ä¸‹æ»‘ç»§ç»­å½•éŸ³çš„æ•ˆæœ
æˆ‘åœ¨JPAudioViewä¸­åˆ©ç”¨äº†ä¸‹é¢ç€ä¸‰ä¸ªæ–¹æ³•æ¥è®©audioViewå¯¹ç”¨æˆ·æ‰‹åŠ¿å˜åŒ–è¿›è¡Œåˆ¤æ–­(å¼€å§‹ç‚¹å‡»ã€å‘ä¸Šå‘ä¸‹æ»‘åŠ¨ã€æ‰‹æŒ‡ç¦»å¼€)ï¼Œå¹¶ä½œå‡ºç›¸åº”çš„å¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event;
- (void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event ;
- (void)touchesEnded:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event;
```
åœ¨ä¸Šé¢è¿™ä¸‰ä¸ªæ–¹é¢ä¸­è§£å†³è‡ªèº«çš„UIé—®é¢˜ï¼Œå†é€šè¿‡blockä»å¤–éƒ¨æ¥å®ç°å½•éŸ³ä»¥åŠæ ¹æ®è¯­éŸ³å¼ºåº¦æ›´æ–°UIçš„æ•ˆæœï¼š

```
/// AudioView blockå—çš„å®ç°(JPChatBottomBar.m)
- (JPAudioView *)audioView {
    if(!_audioView) {
        JPAudioView * tmpView = [[JPAudioView alloc] initWithFrame:CGRectMake(self.textView.x, self.textView.y, self.textView.width,  _btnWH )];
        [self addSubview:tmpView];
        _audioView = tmpView;
        // å®ç°audioViewçš„æ–¹æ³•
        __weak typeof (self) wSelf = self;
        _audioView.pressBegin = ^{
            [wSelf.audioView setAudioingImage:[UIImage imageNamed:@"zhengzaiyuyin_1"] text:@"æ¾å¼€æ‰‹æŒ‡ï¼Œä¸Šæ»‘å–æ¶ˆ"];
            // å¼€å§‹å½•éŸ³
            [wSelf.recoder jp_recorderStart];
        };
        _audioView.pressingUp = ^{
            [wSelf.audioView setAudioingImage:[UIImage imageNamed:@"songkai"] text:@"æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€"];
        };
        _audioView.pressingDown = ^{
            NSString * imgStr = [NSString stringWithFormat:@"zhengzaiyuyin_%d",imageIndex];
            [wSelf.audioView setAudioingImage:[UIImage imageNamed:imgStr] text:@"æ¾å¼€å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ"];
        };
        _audioView.pressEnd = ^{
            [wSelf.audioView setAudioViewHidden];
            [wSelf.recoder jp_recorderStop];
            NSString * filePath = [wSelf.recoder getfilePath];
            NSData * audioData = [NSData dataWithContentsOfFile:filePath];
            /// å°†è¯­éŸ³æ¶ˆæ¯dataé€šè¿‡ä»£ç†å‘å¤–ä¼ é€’
            if(wSelf.agent && [wSelf.agent respondsToSelector:@selector(msgEditAgentAudio:)]){
                [wSelf.agent msgEditAgentAudio:audioData];
            }
            if(wSelf.msgEditAgentAudioBlock){
                wSelf.msgEditAgentAudioBlock(audioData);
            }
        };
    }
    return _audioView;
}
```
å…¶æ¬¡å°±æ˜¯è¿™ä¸€å—æ¯”è¾ƒå…³é”®çš„ç‚¹ï¼š
***æ ¹æ®è¯­éŸ³çš„å¼ºåº¦æ¥åˆ·æ–°audioViewçš„UI***

å‚è§æ•ˆæœå¦‚ä¸‹ï¼š
<center>![åˆ†è´å¼ºåº¦UIçš„åˆ·æ–°](/images/02_post/yuyinshuaxin.gif)</center>

æˆ‘ä»¬é¦–å…ˆè·å–è¯­éŸ³å¼ºåº¦å¹³å‡å€¼çš„æ–¹æ³•ä¸»è¦é€šè¿‡ï¼š

```
/// æ›´æ–°æµ‹é‡å€¼
- (void)updateMeters; /* call to refresh meter values */
/// è·å–å³°å€¼
- (float)peakPowerForChannel:(NSUInteger)channelNumber; 
/// è·å–å¹³å‡å€¼
- (float)averagePowerForChannel:(NSUInteger)channelNumber; 
```
***åœ¨è·å–è¯­éŸ³å¼ºåº¦çš„æ—¶å€™ï¼Œéœ€è¦å…ˆ`updateMeters`æ›´æ–°ä¸€ä¸‹æµ‹é‡å€¼ã€‚***
ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡æµ‹é‡å€¼ ã€ å³°å³°å€¼ä¹‹åï¼Œæ ¹æ®ä¸€å®šçš„ç®—æ³•æ¥è®¡ç®—å‡ºæ­¤æ—¶å£°éŸ³çš„ç›¸å¯¹å¤§å°å¼ºåº¦ã€‚è¿™é‡Œï¼Œç®—æ³•å¾ˆåƒåœ¾çš„æˆ‘ç®€å•çš„è®¾è®¡äº†ä¸€ä¸ª:

```
// JPPlayerHelper.m
- (CGFloat)audioPower {
    [self.recorder updateMeters];           // æ›´æ–°æµ‹é‡å€¼
    float power = [self.recorder averagePowerForChannel:0];     // å¹³å‡å€¼ å–å¾—ç¬¬ä¸€ä¸ªé€šé“çš„éŸ³é¢‘ï¼Œæ³¨æ„éŸ³é¢‘çš„å¼ºåº¦ä¸º[-160,0],0æœ€å¤§
//    float powerMax = [self.recorder peakPowerForChannel:0];
//    CGFloat progress = (1.0/160.0) * (power + 160);
    power = power + 160 - 50;
    int dB = 0;
    if (power < 0.f) {
        dB = 0;
    } else if (power < 40.f) {
        dB = (int)(power * 0.875);
    } else if (power < 100.f) {
        dB = (int)(power - 15);
    } else if (power < 110.f) {
        dB = (int)(power * 2.5 - 165);
    } else {
        dB = 110;
    }
    return dB;
}
```
> å…³äºè¿™ä¸€å—çš„ç®—æ³•ï¼Œå¦‚æœå„ä½è¯»è€…æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œæ¬¢è¿æå‡ºï¼Œæˆ‘ä¹Ÿæ˜¯ä¸ªæ¸´æœ›çŸ¥è¯†çš„å°ç™½ã€‚

é€šè¿‡ä¸Šé¢çš„æ–¹æ³•å¯ä»¥è·å–ç›¸åº”çš„å£°éŸ³çš„åˆ†è´å¼ºåº¦ï¼Œæˆ‘ä»¬å¤–éƒ¨å¯ä»¥åšä¸€äº›å¤„ç†ï¼šä¾‹å¦‚æˆ‘åšäº†ï¼Œå½“æ–°æµ‹é‡å€¼æ¯”æ—§çš„æµ‹é‡å€¼å¤§ä¸€å®šå€¼çš„æ—¶å€™ï¼Œå°±åšæé«˜åˆ†è´çš„UIåˆ·æ–°æ“ä½œï¼Œä½çš„æ—¶å€™å°±åšé™ä½åˆ†è´UIçš„æ“ä½œï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```
// JPChatbottomBar.m
- (void) jpHelperRecorderStuffWhenRecordWithAudioPower:(CGFloat)power{
    NSLog(@"%f",power);
    NSString * newPowerStr =[NSString stringWithFormat:@"%f",[self.helper audioPower]];
    if([newPowerStr floatValue] > [self.audioPowerStr floatValue]) {
        if(imageIndex == 6){
            return;
        }
        imageIndex ++;
    }else {
        if(imageIndex == 1){
            return;
        }
        imageIndex --;
    }
    if(self.audioView.state == JPPressingStateUp) {
        self.audioView.pressingDown();
    }
    self.audioPowerStr =  newPowerStr;;
}
```

å…¶æ¬¡ï¼Œæˆ‘åœ¨`JPPlayerHepler`åŠ äº†ä¸€ä¸ªè®¡æ—¶å™¨æ¥è§¦å‘åå¤è°ƒç”¨ä¸Šé¢çš„ä»£ç†æ–¹æ³•(` - (void) jpHelperRecorderStuffWhenRecordWithAudioPower:(CGFloat)power `) ï¼Œè®©å…¶å¯ä»¥è¿›è¡ŒUIçš„åˆ·æ–°ï¼Œå› ä¸ºå¦‚æœä¸åŠ è®¡æ—¶å™¨ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰äº‹ä»¶å»è§¦å‘`audioView `UIåˆ·æ–°çš„æ“ä½œï¼Œè®¡æ—¶å™¨ç›¸å…³æ–¹æ³•å¦‚ä¸‹:

```
// JPPlayerHelper.m
-(NSTimer *)timer{
    if (!_timer) {
        _timer=[NSTimer scheduledTimerWithTimeInterval:0.35 target:self selector:@selector(doOutsideStuff) userInfo:nil repeats:YES];
    }
    return _timer;
}
- (void)doOutsideStuff {
    
    if(self.delegate && [self.delegate respondsToSelector:@selector(jpHelperRecorderStuffWhenRecordWithAudioPower:)]){
        [self.delegate jpHelperRecorderStuffWhenRecordWithAudioPower:[self audioPower]];
    }
}
```
å®Œæˆå½•éŸ³ä¹‹åï¼Œæœ€ç»ˆæˆ‘ä»¬çš„è¯­éŸ³æ•°æ®é€šè¿‡`JPChatBottomBarDelegate`çš„ä»£ç†æ–¹æ³•å‘å¤–æä¾›ã€‚

å…³äºè·å–è¯­éŸ³å¼ºåº¦é‚£ä¸€å—çš„ç®—æ³•å¹¶ä¸æ˜¯æœ€ä¼˜ï¼Œæˆ‘è§‰å¾—æˆ‘çš„ç®—æ³•ä¹Ÿæ˜¯æ¯”è¾ƒç¬¨æ‹™å­˜åœ¨ç¼ºç‚¹ï¼ˆå¯¹ç”¨æˆ·è¯­éŸ³å¼ºåº¦çš„å˜åŒ–ä¸æ•æ„Ÿï¼‰ã€‚å¦‚æœè·¯è¿‡çš„è¯»è€…æœ‰ä»€ä¹ˆä¸é”™çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºè¡¥å……ï¼Œæˆ‘ä¹Ÿä¼šé‡‡çº³ï¼Œè°¢è°¢ğŸ™ğŸ™ğŸ™ã€‚

## 'æ›´å¤š' é”®ç›˜ ä¸Šé¢çš„Item
`JPChatBottomBar`é‡Œé¢çš„â€˜æ›´å¤šâ€™é”®ç›˜ä¸å¾®ä¿¡çš„ç±»ä¼¼ã€‚
<center>![â€˜æ›´å¤šâ€™é”®ç›˜](/images/02_post/gengduojianpan.jpg)</center>
å¼€å‘è€…åœ¨ä½¿ç”¨çš„æ—¶å€™å¦‚æœæƒ³è¦é”®å…¥ä¸åŒçš„åŠŸèƒ½å®ç°ï¼Œåªè¦åœ¨`/ImageResource/JPMoreBundle.bundle` çš„`JPMorePackageList.plist`æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„item

<center>![JPMorePackageList.plistå±•ç¤º](/images/02_post/gengduojianpanplistyemian.jpg)</center>

> å†…éƒ¨ä¹Ÿå·²ç»åšå¥½äº†é€‚é…çš„æ•ˆæœï¼Œä¸è¿‡å½“itemæ•°é‡è¶…è¿‡8ä¸ªæ—¶å€™ï¼Œæ²¡æœ‰å®Œæˆåƒå¾®ä¿¡çš„é‚£ç§åˆ†é¡µæ•ˆæœï¼ŒåæœŸæˆ‘ä¼šç»§ç»­å®Œå–„ã€‚

å½“ç”¨æˆ·ç‚¹å‡»äº†ä¸Šé¢çš„æŸä¸ªitemä¹‹åï¼Œæˆ‘ä»¬å°±å°†äº‹ä»¶é€šè¿‡`JPChatBottomBarDelegate`å‘å¤–é¢ä¼ é€’ï¼Œå¼€å‘è€…å¯ä»¥å†æœ€å¤–å±‚åšå¤„ç†ï¼Œæ ¹æ®ç‚¹å‡»å“ªä¸ªitemå“åº”ç›¸åº”çš„æ–¹æ³•åŠŸèƒ½ï¼Œç±»ä¼¼å¦‚ä¸‹ä»£ç ï¼š

```
// ViewController.m
NSString * kJPDictKeyImageStrKey = @"imageStr";
- (void)msgEditAgentClickMoreIVItem:(NSDictionary *)dict {
    NSString * judgeStr = dict[kJPDictKeyImageStrKey];
    if([judgeStr isEqualToString:@"photo"]){
        NSLog(@"ç‚¹å‡»äº†å›¾å†Œ");
    }else if([judgeStr isEqualToString:@"camera"]){
        NSLog(@"ç‚¹å‡»äº†æ‘„åƒå¤´");
    }else if([judgeStr isEqualToString:@"file"]) {
        NSLog(@"ç‚¹å‡»äº†æ–‡ä»¶");
    }else if([judgeStr isEqualToString:@"location"]) {
        NSLog(@"ç‚¹å‡»äº†ä½ç½®");
    }
}
```

ä¸€å¼€å§‹æ²¡æœ‰æƒ³ç€å°†ç”¨æˆ·ç‚¹å‡»å“ªä¸ªitemæš´éœ²åœ¨å¤–é¢ï¼Œä½†åæ¥æƒ³äº†å¼€å‘è€…é¢ä¸´çš„ä¸šåŠ¡å¤šç§å¤šæ ·ï¼Œä¸ºäº†æ›´å¥½çš„æ‰©å±•ï¼Œç®€åŒ–`JPChatBottomBar`çš„ç»“æ„ï¼Œå°±å°†è¿™éƒ¨åˆ†ä¹Ÿé€šè¿‡ä»£ç†å†™å‡ºæ¥ã€‚

## æ–‡æœ¬æ¶ˆæ¯çš„ç¼–è¾‘ï¼ˆå‘é€ã€åˆ é™¤ã€åµŒå…¥è¡¨æƒ…åŒ…æ–‡æœ¬ï¼‰
> æˆ‘èŠ±äº†æ¯”è¾ƒå¤šçš„æ—¶é—´åœ¨è¿™ä¸€éƒ¨åˆ†ä¸Šé¢ï¼Œä¹‹å‰æ²¡æœ‰çœŸæ­£çš„åšåµŒå…¥è¡¨æƒ…åŒ…çš„æ–¹æ³•ï¼Œåªæ˜¯é€šè¿‡è°ƒç”¨åŸç”Ÿçš„è¡¨æƒ…æ¥å®ç°è¡¨æƒ…çš„ç¼–è¾‘

è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ€è€ƒ å½“ç”¨æˆ·ç‚¹å‡»è¡¨æƒ…åŒ…çš„æ—¶å€™æˆ‘ä»¬è¦åšå“ªäº›å¤„ç†ã€‚
å…ˆè®²æˆ‘ä»¬çš„é—®é¢˜åŒ–ç®€ä¸€ä¸‹ã€‚


### è¡¨æƒ…åŒ…åˆ†ä¸¤ç§
è§‚å¯Ÿå¾®ä¿¡ï¼Œè¡¨æƒ…åŒ…ä¸»è¦åˆ†ä¸¤å¤§ç§ï¼Œä¸€ç§æ˜¯å¯ä»¥åµŒå…¥æ–‡æœ¬æ¡†çš„è¡¨æƒ…ï¼Œè€Œå¦ä¸€ç§æ˜¯å½“ç”¨æˆ·ç‚¹å‡»äº†è¯¥è¡¨æƒ…ä¹‹åç›´æ¥å°±å‘é€ç»™èŠå¤©å¯¹è±¡ï¼Œä¸‹é¢æˆ‘ä»¬ç§°è¿™ä¸¤ç§è¡¨æƒ…åˆ†åˆ«ä¸ºSmallEmojiï¼ˆå‰è€…ï¼‰å’ŒLargeEmojiï¼ˆåè€…ï¼‰ã€‚

åè€…çš„å®ç°æ–¹å¼å¯ä»¥é€šè¿‡æ¯ä¸€å±‚é—´ä»£ç†å°†å…¶æš´éœ²åœ¨å¤–ã€‚
```
// JPChatBottomBar.h
/**
 *  ç”¨æˆ·ç‚¹å‡»äº†é”®ç›˜çš„è¡¨æƒ…åŒ…æŒ‰é’®
 *  @param bigEmojiData :   å¤§è¡¨æƒ…åŒ…çš„data
 */
- (void)msgEditAgentSendBigEmoji:(NSData *)bigEmojiData;
```

å…³äºâ€œç‚¹å‡»SmallEmojiåµŒå…¥æ–‡æœ¬â€ï¼Œæˆ‘æ”¾åè°ˆè°ˆã€‚

### è¡¨æƒ…åŒ…çš„åŠ è½½
è¿™é‡Œæˆ‘é€šè¿‡`JPEmojiManager` å°†è¡¨æƒ…åŒ…ä»`/ImageResource/JPEmojiBundle.bundle`ä¸­åŠ è½½å‡ºæ¥ï¼Œä¸ºä¸€ä¸ªè¡¨æƒ…åŒ…åœ¨`JPEmojiPackageList.plist`ä¸­éƒ½æœ‰å¯¹åº”çš„itemè¿›è¡Œç»‘å®šï¼Œå› æ­¤ï¼Œå¦‚æœåæœŸæˆ‘ä»¬æœ‰æ–°çš„è¡¨æƒ…åŒ…ï¼Œåªè¦æŠŠå›¾ç‰‡å­˜è¿›å»ï¼Œå¹¶ä¸”åœ¨plistæ–‡ä»¶ä¸­å¢åŠ æ–°çš„itemå³å¯ä»¥ï¼Œä»£ç å®ç°ç”¨æˆ·åŠ¨æ€æ·»åŠ è¡¨æƒ…åŒ…çš„æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

è€Œä¸ºäº†é¿å…é‡å¤åœ°è¯»å–æ–‡ä»¶ï¼Œæˆ‘å°†`JPEmojiManager`å†™æˆäº†å•ä¾‹ã€‚

```
// JPEmojiManager.h

/**
 *  @return è·å–æ‰€æœ‰çš„è¡¨æƒ…ç»„
 */
- (NSArray <JPEmojiGroupModel *> *)getEmogiGroupArr;

/**
 *  æ ¹æ®ä½ç½®è·å–ç›¸åº”çš„æ¨¡å‹æ•°ç»„
 *  @param group : é€‰æ‹©äº†å“ªä¸€ç»„è¡¨æƒ…
 *  @param page : é¡µç 
 *  @return æ ¹æ®å‰é¢ä¸¤ä¸ªå‚æ•°ä»æ‰€æœ‰æ•°æ®ä¸­æ ¹æ®å¯¹åº”çš„ä½ç½®å’Œå¤§å°å–å‡ºè¡¨æƒ…æ¨¡å‹(<= 20ä¸ª)
 */
- (NSArray <JPEmojiModel *> *)getEmojiArrGroup:(NSInteger)group page:(NSInteger)page;
```
è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç±»
- `JPEmojiModel`ç”¨äºç»‘å®šå•ç‹¬ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œ
- `JPEmojiGroupModel`ç”¨äºç»‘å®šä¸€æ•´ç»„çš„è¡¨æƒ…åŒ…

`JPEmojiManager`ä¸­çš„è¿™ä¸¤ä¸ªæ–¹æ³•æ›´å¤šæ˜¯æœåŠ¡äºåˆ†é¡µè¡¨æƒ…åŒ…çš„æ•ˆæœï¼ˆä¸‹é¢æˆ‘å°†è¦è°ˆåˆ°ï¼‰

### è¡¨æƒ…åŒ…çš„åˆ†é¡µæ•ˆæœ
åœ¨çœ‹è¿‡githubä¸Šé¢åˆ«äººè¡¨æƒ…åŒ…demoä¹‹åï¼Œæœ‰ä¸€äº›å¹¶æ²¡æœ‰å®ç°æ»‘åŠ¨åˆ‡æ¢è¡¨æƒ…åŒ…ç»„ï¼Œäºæ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ªï¼Œæ•ˆæœå‚è€ƒå¦‚ä¸‹:
<center>![è¡¨æƒ…åŒ…ç»„çš„åˆ‡æ¢](/images/02_post/biaoqingbaofenye.gif)</center>

åˆ†ä¹Ÿæ•ˆæœçš„å®ç°æ–¹å¼ï¼šé€šè¿‡ä¸‰ä¸ªviewå»å¤ç”¨ï¼Œåœ¨`ScrollView`ä¸­å»è½®æµå±•ç¤ºã€‚

```
// JPEmojiInputView.m
#pragma mark ä¸‰ä¸ªviewå¤ç”¨
@property (strong, nonatomic) JPInputPageView * leftPV;
@property (strong, nonatomic) JPInputPageView * currentPV;
@property (strong, nonatomic) JPInputPageView * rightPV;
```
é€šè¿‡å‰é¢`JPEmojiManager`ä¸­å–å‡ºå¯¹åº”é¡µæ•°çš„è¡¨æƒ…åŒ…ä¹‹åï¼Œç„¶åè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•è®²æ¯ä¸€é¡µçš„è¡¨æƒ…åŒ…ä¼ å…¥æ¯ä¸€ä¸ªåˆ†é¡µ
```
// JPInputPageView.h
/**
 *  èµ‹äºˆæ–°çš„æ•°ç»„ï¼Œé‡æ–°åˆ·æ–°æ•°æ®æº
 *  @param  emojiArr : ä¸€é¡µçš„è¡¨æƒ…ï¼ˆä½œä¸ºå†…ç½®CollectionViewçš„æ•°æ®
 */
- (void)setEmojiArr:(NSArray <JPEmojiModel *> *)emojiArr isShowLargeImage:(BOOL)value;
```
å…ˆæ¥è®²è®²ä¸‰ä¸ªåˆ†é¡µå®ç°å±•ç¤ºæ‰€æœ‰è¡¨æƒ…çš„æ•ˆæœï¼š
- 1.é¦–å…ˆå°†ScrollViewçš„contentSizeæ‰©å¤§åˆ°èƒ½å®¹çº³è¡¨æƒ…åŒ…æ€»å…±é¡µæ•°çš„å¤§å°
- 2.é™¤äº†ç¬¬ä¸€ç»„è¡¨æƒ…åŒ…çš„ç¬¬ä¸€é¡µå’Œæœ€åä¸€ç»„è¡¨æƒ…åŒ…çš„æœ€åä¸€é¡µï¼ˆä»€ä¹ˆéƒ½ä¸ç”¨åšï¼‰ï¼Œå…¶ä»–æ—¶åˆ»ï¼Œå±•ç¤ºåœ¨ç”¨æˆ·é¢å‰çš„é‚£ä¸€é¡µå§‹ç»ˆæ˜¯ï¼š`self.currentPV`ã€‚
- 3.å½“æ‰‹æŒ‡å‘å·¦æ»‘å»å±•ç¤ºä¸‹ä¸€é¡µè¡¨æƒ…æ—¶å€™ï¼Œ`leftPv`ç§»åŠ¨åˆ°äº†æœ€å³è¾¹ï¼ŒåŒæ—¶å»é™¤è¯¥é¡µçš„è¡¨æƒ…åŒ…ï¼Œåšå¥½å±•ç¤ºçš„å‡†å¤‡ã€‚å®Œæˆè¿™ä¸€æ­¥ä¹‹åï¼Œå°±æ˜¯æ›´æ¢æ¯å­ä¸­çš„æ°´çš„é—®é¢˜äº†ï¼Œå°†ä¸‰ä¸ªå¤ç”¨viewçš„ç›¸äº’èµ‹å€¼ï¼š

```
// JPEmojiInputView.m
JPInputPageView * tmpView ;
 tmpView = self.leftPV;
 self.leftPV = self.currentPV;
self.currentPV = self.rightPV;
self.rightPV = tmpView;
```

æˆ‘é€šè¿‡ä¸‹é¢çš„å›¾ç‰‡æ¥å±•ç¤ºè¿™ä¸€å—åº•å±‚çš„å®ç°ï¼Œå¯èƒ½å¯ä»¥æ–¹ä¾¿å¤§å®¶ç†è§£ï¼š
<center>![è§£é‡Šåˆ†é¡µæ•ˆæœçš„åº•å±‚](/images/02_post/tupianzhenshifenye.jpg)</center>

å½“ç”¨æˆ·æ‰‹æŒ‡å‘å³æ»‘å±•ç¤ºä¸Šä¸€é¡µçš„æ—¶å€™ï¼Œåº•éƒ¨å®ç°çš„æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä»¥æ­¤ç±»æ¨ã€‚
æ›´å¤šç»†èŠ‚ï¼ˆå¦‚ä½•è®¡ç®—å½“å‰é¡µå¯¹åº”å“ªä¸€ç»„è¡¨æƒ…åŒ…çš„å“ªä¸€é¡µç­‰ï¼‰å¯ä»¥å‚è€ƒæˆ‘å†™åœ¨`JPEmojiInputView.m`é‡Œçš„`- (void)scrollViewDidScroll:(UIScrollView *)scrollView `ã€‚

### ç‚¹å‡»SmallEmojiåµŒå…¥æ–‡æœ¬
iOS ä¸­textViewå’ŒtextFieldå¯ä»¥è‡ªåŠ¨è¯†åˆ«ç³»ç»ŸåŸç”Ÿçš„è¡¨æƒ…ï¼š
<center>![ç³»ç»ŸåŸç”Ÿçš„è¡¨æƒ…](/images/02_post/xitongyuanshengbiaoqing.jpg)</center>

è€Œé’ˆå¯¹æˆ‘ä»¬å¼€å‘è€…å¦å¤–æ·»åŠ çš„å°è¡¨æƒ…ï¼ŒtextViewå’ŒtextFieldä¸èƒ½ç›´æ¥è¯†åˆ«ã€‚

è¿™é‡Œå¯ä»¥å‚è€ƒäº†å‡ ä¸ªä¸»æµappçš„å®ç°æ–¹å¼ï¼Œ
- 1.å¾®åšï¼š ç‚¹å‡»è¡¨æƒ…åŒ…åµŒå…¥è¡¨æƒ…å›¾ç‰‡ï¼›
- 2.å¾®ä¿¡ï¼šç‚¹å‡»éåŸç”Ÿè¡¨æƒ…åŒ…åµŒå…¥è¯¥è¡¨æƒ…åŒ…æè¿°æ–‡æœ¬ã€‚

è€Œè¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬å°†â€˜å›¾æ–‡æ··ç¼–â€™çš„æ–‡æœ¬æ¶ˆæ¯å‘é€å‡ºå»ç»è¿‡æˆ‘ä»¬æœåŠ¡å™¨çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯ä¸å¯¹å­—ç¬¦ä¸²ä¸­çš„å›¾ç‰‡ä¿¡æ¯è¿›è¡Œè§£æï¼Œå› æ­¤ï¼Œåº•å±‚ä¾æ—§æ˜¯å‘æœåŠ¡å™¨ä¼ é€’çº¯æ–‡æœ¬æ¶ˆæ¯ï¼Œè€Œå¯¹é‡Œé¢çš„å›¾ç‰‡ä¿¡æ¯åšäº†å¤„ç†è½¬æ¢æˆäº†è¡¨æƒ…åŒ…çš„æè¿°æ–‡æœ¬ï¼Œä¸‹é¢æˆ‘ç”¨ä¸€å¼ å›¾ç‰‡è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼š
<center>![æ”¶å‘æµç¨‹](/images/02_post/biaoqingbaofasongliucheng.jpg)</center>

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ¬åœ°éœ€è¦å¯¹è¿™äº›â€œå›¾æ–‡æ··ç¼–â€çš„æ–‡æœ¬è½¬æ¢æˆçº¯æ–‡æœ¬æ‰èƒ½å‘é€è‡³æœåŠ¡ç«¯ã€‚è¿™é‡Œä¸»è¦é€šè¿‡ä¸¤ä¸ªç³»ç»Ÿçš„ç±»æ¥è¿›è¡Œè¡¨æƒ…åŒ…å’Œå…¶æè¿°æ–‡æœ¬çš„åŒ¹é…ã€‚
- 1.`NSTextAttachment` : æ–‡æœ¬ä¸­çš„â€˜æ’ä»¶â€™ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªç±»æ¥æ’å…¥å›¾ç‰‡ã€‚
- 2.`NSRegularExpression` : ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…å­—ç¬¦ä¸²ä¸­çš„è¡¨æƒ…åŒ…æè¿°æ–‡æœ¬ã€‚

å…³äºæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™é‡Œæœ‰ä¸€ç¯‡æ¯”è¾ƒå…¨çš„è¯­æ³•:[æ­£åˆ™è¡¨è¾¾å¼](https://www.jianshu.com/p/ea10003d224a)ã€‚

è¿™é‡Œæˆ‘çš„æ­£åˆ™åŒ¹é…çš„å­—ç¬¦å¦‚ä¸‹ï¼š

`NSRegularExpression *regex = [NSRegularExpression regularExpressionWithPattern:@"\\[.+?\\]" options:0 error:NULL];`

åœ¨åŒ¹é…å‡ºæ¯ä¸€ä¸ªè¡¨æƒ…åŒ…æè¿°æ–‡æœ¬ä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ•°ç»„å­˜æ”¾è¿™äº›åŒ¹é…ç»“æœ(æè¿°æ–‡æœ¬ã€å›¾ç‰‡èµ„æºã€æè¿°æ–‡æœ¬åœ¨åŸå­—ç¬¦ä¸²çš„ä½ç½®)ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„ï¼Œå°†è¿™äº›æè¿°æ–‡æœ¬é€šè¿‡æ’å…¥å›¾ç‰‡æ’ä»¶`textAttachment`æ¥æ›¿æ¢ï¼Œ***è¿™é‡Œæ³¨æ„***ï¼Œæ¯æ¬¡æ›¿æ¢ï¼Œåé¢è¿˜æ²¡æœ‰è¢«æ›¿æ¢çš„è¡¨æƒ…åŒ…æ–‡æœ¬çš„rangeå°±ä¼šå‘é€å˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦é€’å‡ä»–ä»¬åŸæ¥çš„ä½ç½®`range.location`ã€‚
å…·ä½“å®ç°çš„æ–¹å¼å¯å‚è€ƒä¸‹é¢ä»£ç :

```
// JPAttributedStringHelper.m
- (NSAttributedString *)getTextViewArrtibuteFromStr:(NSString *)str {
    if(str.length == 0) {
        return nil;
    }
    NSMutableAttributedString * attStr = [[NSMutableAttributedString alloc]  initWithString:str
                                                                                 attributes:[JPAttributedStringConfig getAttDict]];
    
    NSMutableParagraphStyle * paraStyle = [[NSMutableParagraphStyle alloc] init];
    paraStyle.lineSpacing = 5;
    [attStr addAttribute:NSParagraphStyleAttributeName value:paraStyle range:NSMakeRange(0, attStr.length)];
    
    NSArray<JPEmojiMatchingResult *> * emojiStrArr = [self analysisStrWithStr:str];
    if(emojiStrArr && emojiStrArr.count != 0) {
        NSInteger offset = 0;           // è¡¨æƒ…åŒ…æ–‡æœ¬çš„åç§»é‡
        for(JPEmojiMatchingResult * result in emojiStrArr ){
            if(result.emojiImage ){
                // è¡¨æƒ…çš„ç‰¹æ®Šå­—ç¬¦
                NSMutableAttributedString * emojiAttStr = [[NSMutableAttributedString alloc] initWithAttributedString:[NSAttributedString attributedStringWithAttachment:result.textAttachment]];
                if(!emojiAttStr) {
                    continue;
                }
                NSRange actualRange = NSMakeRange(result.range.location - offset, result.range.length);
                [attStr replaceCharactersInRange:actualRange withAttributedString:emojiAttStr];
                // ä¸€ä¸ªè¡¨æƒ…å ä¸€ä¸ªé•¿åº¦
                offset += (result.range.length-1);
            }
        }
        return attStr;
    }else {
        return [[NSAttributedString alloc] initWithString:str attributes:[JPAttributedStringConfig getAttDict]];;
    }
}
```
å®ç°çš„æ•ˆæœ:
<center>![å‘é€'å›¾æ–‡æ··ç¼–'æ–‡æœ¬](/images/02_post/biaoqingbaofasong.gif)</center>

è€Œåœ¨æŒ‰ä¸‹åˆ é™¤é”®ï¼Œè¦å®ç°åˆ é™¤è¡¨æƒ…åŒ…æè¿°æ–‡æœ¬ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­`textView.selectedRange`æ‰€åœ¨çš„ä½ç½®æ˜¯å¦ä¸ºè¡¨æƒ…æè¿°æ–‡æœ¬ï¼Œä»£ç å‚è€ƒå¦‚ä¸‹ï¼š

```
// ç‚¹å‡»äº†æ–‡æœ¬æ¶ˆæ¯å’Œæˆ–è€…è¡¨æƒ…åŒ…é”®ç›˜çš„åˆ é™¤æŒ‰é’®
- (void)clickDeleteBtnInputView:(JPEmojiInputView *)inputView {
    NSString * souceText = [self.textView.text substringToIndex:self.textView.selectedRange.location];
    if(souceText.length == 0) {
        return;
    }
    NSRange  range = self.textView.selectedRange;
    if(range.location == NSNotFound) {
        range.location = self.textView.text.length;
    }
    if(range.length > 0) {
        [self.textView deleteBackward];
        return;
    }else {
        // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¦æ›¿æ¢çš„æ–‡å­—çš„èŒƒå›´
        if([souceText hasSuffix:@"]"]){
            // è¡¨ç¤ºè¯¥é€‰å–å­—æ®µæœ€åä¸€ä¸ªæ˜¯è¡¨æƒ…åŒ…
            if([[souceText substringWithRange:NSMakeRange(souceText.length-2, 1)] isEqualToString:@"]"]) {
                // è¡¨ç¤ºè¿™åªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å­—ç¬¦@"]"
                [self.textView deleteBackward];
                return;
            }
            // æ­£åˆ™è¡¨è¾¾å¼
            NSString * pattern = @"\\[[a-zA-Z0-9\\u4e00-\\u9fa5]+\\]";
            NSError *error = nil;
            NSRegularExpression * re = [NSRegularExpression regularExpressionWithPattern:pattern options:NSRegularExpressionCaseInsensitive error:&error];if (!re) {NSLog(@"%@", [error localizedDescription]);}
            NSArray *resultArray = [re matchesInString:souceText options:0 range:NSMakeRange(0, souceText.length)];
            if(resultArray.count != 0) {
                /// è¡¨æƒ…æœ€åä¸€æ®µå­˜åœ¨è¡¨æƒ…åŒ…å­—ç¬¦ä¸²
                NSTextCheckingResult *checkingResult = resultArray.lastObject;
                NSString * resultStr = [souceText substringWithRange:NSMakeRange(0, souceText.length - checkingResult.range.length)];
                self.textView.text = [self.textView.text stringByReplacingCharactersInRange:NSMakeRange(0, souceText.length) withString:resultStr];
                self.textView.selectedRange = NSMakeRange(resultStr.length , 0);
            }else {
                [self.textView deleteBackward];
            }
        }else {
            // è¡¨ç¤ºæœ€åä¸€ä¸ªä¸æ˜¯è¡¨æƒ…åŒ…
            [self.textView deleteBackward];
        }
    }
    // textViewè‡ªé€‚åº”
    [self textViewDidChange:self.textView];
}

```
å®ç°æ•ˆæœå¤§å®¶å¯ä»¥çœ‹çœ‹demoğŸ¤“ã€‚

> çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘å·²ç»å†™äº†è¿‘5kå­—äº†ğŸ˜‚
### è¡¨æƒ…åŒ…çš„é¢„è§ˆ

è¡¨æƒ…åŒ…çš„é¢„è§ˆæ•ˆæœåˆ†ä¸º
- 1.å°è¡¨æƒ…çš„é¢„è§ˆ
- 2.å¤§è¡¨æƒ…çš„é¢„è§ˆï¼ˆgifæ’­æ”¾ï¼‰

#### å±•ç¤º
å‰è€…çš„åº•éƒ¨è§†å›¾æ˜¯ä¸€å¼ å·²ç»ç”»å¥½çš„å›¾ç‰‡ï¼Œ
<center>![å°è¡¨æƒ…åŒ…çš„åº•éƒ¨è§†å›¾](/images/02_post/xiaobiaoqingdibushitu.jpg)</center>

åè€…çš„åº•éƒ¨è§†å›¾æˆ‘é€šè¿‡é‡ç»˜æœºåˆ¶(`QuartzCore`æ¡†æ¶å¹¶ä¸”é‡å†™`-drawRect: `æ–¹æ³•)æ¥è¿›è¡Œæè¾¹ä»¥åŠè§†å›¾é¢œè‰²çš„å¡«å……(å…³äºé‡ç»˜åˆ¶:[iOSå¼€å‘ä¹‹drawRectçš„ä½œç”¨å’Œè°ƒç”¨æœºåˆ¶](https://blog.csdn.net/xiaoxiaobukuang/article/details/51594157))ï¼Œä»£ç :

```
// JPGIfPreview.m
- (void)drawRect:(CGRect)rect {
    CGContextRef context = UIGraphicsGetCurrentContext();
    //1.æ·»åŠ ç»˜å›¾è·¯å¾„
    CGContextMoveToPoint(context,0,_filletRadius);
    CGContextAddLineToPoint(context, 0, _squareHeight - _filletRadius);
    CGContextAddQuadCurveToPoint(context, 0, _squareHeight ,_filletRadius, _squareHeight);
    CGContextAddLineToPoint(context, (_squareWidht - _triangleWdith )/2,_squareHeight);
    CGContextAddLineToPoint(context,BaseWidth /2 , BaseHeight);
    CGContextAddLineToPoint(context, (_squareWidht + _triangleWdith )/2,_squareHeight);
    CGContextAddLineToPoint(context, _squareWidht - _filletRadius,_squareHeight);
    CGContextAddQuadCurveToPoint(context, _squareWidht, _squareHeight ,_squareWidht, _squareHeight - _filletRadius);
    CGContextAddLineToPoint(context, _squareWidht ,_filletRadius);
    CGContextAddQuadCurveToPoint(context, _squareWidht, 0 ,_squareWidht - _filletRadius, 0);
    CGContextAddLineToPoint(context,_filletRadius ,0);
    CGContextAddQuadCurveToPoint(context, 0, 0 ,0, _filletRadius);
    //2.è®¾ç½®é¢œè‰²å±æ€§
    CGFloat backColor[4] = {1,1,1, 0.86};
    CGFloat layerColor[4] = {0.9,0.9,0.9,0};
    //3.è®¾ç½®æè¾¹é¢œè‰²ï¼Œå¡«å……é¢œè‰²
    CGContextSetFillColor(context, backColor);
    CGContextSetStrokeColor(context, layerColor);
    //4.ç»˜å›¾
    CGContextDrawPath(context, kCGPathFillStroke);
}
```
#### åæ ‡æ¢ç®—
åœ¨å®Œæˆäº†å¸ƒå±€ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦å°†æˆ‘ä»¬çš„é¢„è§ˆè§†å›¾æ·»åŠ åˆ°ç•Œé¢ä¸Šã€‚

åœ¨collectionViewä¸Šé¢æ·»åŠ é•¿æŒ‰æ”¶æ‹¾`longPress`ï¼Œç›‘å¬æ‰‹åŠ¿çš„çŠ¶æ€ï¼Œå¹¶ä¸”è®¡ç®—æ‰‹åŠ¿æ‰€åœ¨ä½ç½®å¯¹åº”çš„cellï¼Œå¯¹å…¶å†…å®¹è¿›è¡Œé¢„è§ˆæ•ˆæœçš„å±•ç¤ºã€‚

è¿™é‡Œæˆ‘é€‰æ‹©äº†`[UIApplication sharedApplication].windows.lastobject`ä½œä¸ºsuperViewï¼Œå³`emojiInputView`æ‰€åœ¨çš„windowã€‚

**è¿™é‡Œæœ‰ä¸ªè¦æ³¨æ„çš„ç‚¹**ï¼Œä¸Šé¢çš„window`CGPointZero`æ˜¯ä»æ‰‹æœºå·¦ä¸Šè§’å¼€å§‹ç®—èµ·ï¼Œå› æ­¤æ¢ç®—åæ ‡(cellæ˜¯æ¯ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œè¡¥å……ä¸€ä¸‹æˆ‘æ˜¯ç”¨collectionViewæ¥å±•ç¤ºæ¯ä¸€ä¸ªåˆ†é¡µä¸Šçš„è¡¨æƒ…åŒ…)æ—¶ï¼Œæˆ‘å°†cell.frameè½¬æ¢æˆäº†åœ¨windowä¸Šçš„frameï¼š
```
CGRect  rect = [[UIApplication sharedApplication].windows.lastObject convertRect:cell.frame fromView:self.collectionView];
```

åæ ‡æ¢ç®—å®Œæˆä¹‹åï¼Œå‰©ä¸‹çš„å°±æ˜¯æ·»åŠ ä¸Šå»ã€‚

#### gifæ’­æ”¾
gifçš„æ’­æ”¾æ•ˆæœï¼Œæˆ‘ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦ï¼Œè¿™é‡Œçœ‹åˆ°ä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼š[iOS-Gifå›¾ç‰‡å±•ç¤ºNç§æ–¹å¼(åŸç”Ÿ+ç¬¬ä¸‰æ–¹)](https://blog.csdn.net/qxuewei/article/details/50782855)ï¼Œé‡Œé¢æœ‰ä»‹ç»åŸç”Ÿå’Œç¬¬ä¸‰æ–¹çš„å®ç°ã€‚
è€ƒè™‘åˆ°å‡å°‘é¡¹ç›®çš„ä¾èµ–åº“ï¼Œè¿™é‡Œæˆ‘å°±é‡‡ç”¨äº†é‡Œé¢åŸç”Ÿæ–¹å¼çš„ä»£ç ï¼Œå…·ä½“å¯ä»¥ç‚¹å¼€é“¾æ¥çœ‹å†…éƒ¨ä»£ç ï¼Œè¿™é‡Œä¸åšè¿‡å¤šå™è¿°äº†ï¼ˆ5.3kå­—äº†ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼‰ã€‚

## å†™åœ¨æœ€å
åœ¨å®Œæˆ`JPChatBottomBar`ä¹‹åï¼Œæ•´ä¸ªæ¡†æ¶è®¿é—®ç”¨æˆ·ç¼–è¾‘çš„æ¶ˆæ¯æˆ–è€…æ˜¯ç”¨æˆ·çš„å…¶ä»–æ“ä½œéƒ½å¯ä»¥é€šè¿‡`JPChatBottomBarDelegate`è·å–ã€‚

`JPChatBottomBar` éƒ¨åˆ†å°±å…ˆåˆ°è¿™é‡Œï¼Œå®Œæˆè¿™éƒ¨åˆ†å†…å®¹ï¼Œä»demoåˆ°æ–‡ç« è½ç¬”å®Œæˆä¹‹é—´ï¼Œé‡åˆ°äº†æŒºå¤šé—®é¢˜ğŸ˜‚ã€‚
ä¾‹å¦‚â€˜åˆ‡æ¢é”®ç›˜è¦†ç›–çš„é—®é¢˜â€™é‚£ä¸€å—è‡ªå·±å°±ç”¨äº†ä¸¤ç§æ–¹æ³•æ¥å®ç°ï¼Œäº¦æˆ–è€…æ˜¯â€˜è¡¨æƒ…åŒ…ç»„åˆ«çš„åˆ‡æ¢â€™ï¼Œè‡ªå·±éƒ½èŠ±äº†æœ‰äº›æ—¶é—´ã€‚

é’ˆå¯¹æˆ‘çš„æ–‡ç« å’Œdemoä¸­æŠ€æœ¯çš„å®ç°ï¼Œå¦‚æœè¯»è€…æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œæ¬¢è¿æå‡ºğŸ™ï¼Œè°¢è°¢ğŸ™ã€‚

ä¹Ÿå¸Œæœ›æˆ‘çš„æ–‡ç« èƒ½å¤Ÿç»™ä½ å¸¦æ¥å¸®åŠ©ã€‚

## å‚è€ƒ
è¿™äº›æ–‡ç« å¯¹æˆ‘æä¾›äº†ä¸€å®šçš„å¸®åŠ©ï¼Œä¹Ÿå¸Œæœ›å¯¹ä½ æœ‰ç”¨

[iOS-Gifå›¾ç‰‡å±•ç¤ºNç§æ–¹å¼(åŸç”Ÿ+ç¬¬ä¸‰æ–¹)](https://blog.csdn.net/qxuewei/article/details/50782855)

[WWDC 2017 - ä¼˜åŒ–è¾“å…¥ä½“éªŒçš„å…³é”®ï¼škeyboardæŠ€å·§å…¨ä»‹ç»](https://kemchenj.github.io/2017-08-07/)

[OCå®ç°iosç±»ä¼¼å¾®ä¿¡è¾“å…¥æ¡†è·Ÿéšé”®ç›˜å¼¹å‡ºçš„æ•ˆæœ](https://www.jianshu.com/p/f7198ee11572)




































